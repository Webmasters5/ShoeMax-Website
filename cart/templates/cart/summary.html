{% extends "BaseTemplate/nav.html" %}
{% load static %}
{% block title %}Cart{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<style>
  .cart-card + .cart-card { margin-top: 1rem; }
  #order-summary { margin-top: 2rem; }
  .qty-form { display: inline-flex; gap: .5rem; align-items:center; }
  .img-thumb { width: 120px; height: 120px; object-fit: cover; border-radius: .5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-3">Shopping Cart</h1>
  <p class="text-muted">View your selected items</p>
  <hr>

<!-- 
  Adapted from 
  https://mdbootstrap.com/docs/standard/extended/shopping-carts/ 
 -->

  {% if cart_items %}
    <div class="row">
      <div class="col-12">
        {% for item in cart_items %}
          <div class="card cart-card shadow-sm">
            <div class="row g-0">
              <div class="col-md-2 d-flex align-items-center justify-content-center p-3">
                {% with main_image=item.variant.shoe.images.first %}
                  {% if main_image %}
                    <img src="{{ main_image.image.url }}" alt="{{ item.variant.shoe.name }}" class="img-thumb">
                  {% else %}
                    <img src="{% static 'images/image-placeholder.png' %}" alt="No image" class="img-thumb">
                  {% endif %}
                {% endwith %}
              </div>

              <div class="col-md-7">
                <div class="card-body">
                  <h5 class="card-title mb-1">{{ item.variant.shoe.name }}</h5>
                  <p class="mb-1 text-muted">{{ item.variant.color }} — Size {{ item.variant.size }}</p>
                  <p class="mb-2">Price: <strong>Rs {{ item.variant.shoe.price }}</strong></p>

                  <form method="post" action="{% url 'cart:update_quantity' item.id %}" class="qty-form">
                    {% csrf_token %}
                    <button class="btn btn-outline-secondary btn-sm" type="submit" name="action" value="decrement" title="Decrease quantity">−</button>
                    <span class="px-2">{{ item.quantity }}</span>
                    <button class="btn btn-outline-secondary btn-sm" type="submit" name="action" value="increment" title="Increase quantity">+</button>
                  </form>

                  <div class="mt-3">
                    <a href="{% url 'cart:remove_item' item.id %}" class="btn btn-danger btn-sm">Remove</a>
                  </div>
                </div>
              </div>

              <div class="col-md-3 d-flex align-items-center justify-content-center p-3">
                <div class="text-center">
                  <div class="text-muted">Item total</div>
                  <div class="fs-5 fw-bold">Rs {{ item.total_price }}</div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div id="order-summary" class="card shadow mt-4">
      <div class="card-body">
        <h4 class="card-title">Order Summary</h4>
        <div class="d-flex justify-content-between mt-3">
          <span>Subtotal</span>
          <span>Rs {{ total }}</span>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <span>Discount</span>
          <span>Rs {{ discount }}</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fs-5 fw-bold">
          <span>Total</span>
          <span>Rs {{ final_total }}</span>
        </div>
        <div class="mt-3 d-flex gap-2">
          <a href="{% url 'cart:checkout' %}" class="btn btn-success">Proceed to Checkout</a>
          <a href="{% url 'homepage:home' %}" class="btn btn-outline-secondary">Continue Shopping</a>
        </div>
      </div>
    </div>

  {% else %}
    <div class="alert alert-info">Your cart is empty.</div>
  {% endif %}
</div>
{% endblock %}